---
phase: 04-dashboard-meals
plan: 01
type: execute
---

<objective>
Build dashboard page with today's nutrition totals, progress bars, and recent meals preview.

Purpose: Provide users with immediate visibility into their daily nutrition intake and progress toward goals. This is the core value proposition - beautiful, actionable insights.
Output: Functional dashboard page showing real-time nutrition totals for today with visual progress indicators and recent meals list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph:
@.planning/phases/02-meal-logging/02-05-SUMMARY.md
@.planning/phases/03-telegram-integration/03-01-SUMMARY.md

# Key files from previous phases:
@app/dashboard/meals/actions.ts
@app/dashboard/meals/page.tsx
@app/dashboard/page.tsx
@app/dashboard/layout.tsx
@lib/supabase/server.ts
@components/meals/MealForm.tsx

**Tech stack available:**
- Next.js 14 App Router with Server Components
- Supabase client with RLS policies
- TypeScript with Zod validation
- Tailwind CSS for styling
- Server Actions pattern with useActionState

**Established patterns:**
- Server Components for data fetching with auth.getUser()
- RLS policies enforce user isolation automatically
- @/lib/supabase/server for Server Component database access
- Datetime handling with logged_at timestamps
- Meal types: breakfast, lunch, dinner, snack

**Constraining decisions:**
- Phase 01: Always use auth.getUser() never getSession() for auth checks
- Phase 01: RLS policies enforce user_id automatically in queries
- Phase 02: All nutrition fields optional (manual entry without AI is valid)
- Phase 02: Confidence scoring: High=0.9, Medium=0.7, Low=0.4
- Phase 02: Avoid route groups in Next.js 16 (causes 404s with Turbopack)

**Database schema (meal_logs):**
- user_id (uuid, foreign key to auth.users)
- title (text)
- description (text, nullable)
- meal_type ('breakfast' | 'lunch' | 'dinner' | 'snack')
- logged_at (timestamp with timezone)
- photo_url (text, nullable)
- source ('manual' | 'telegram_text' | 'telegram_image' | 'web')
- calories (integer, nullable)
- protein (numeric, nullable)
- carbs (numeric, nullable)
- fat (numeric, nullable)
- fiber (numeric, nullable)
- sugar (numeric, nullable)
- sodium (numeric, nullable)
- ai_confidence (numeric 0.0-1.0, nullable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action to fetch today's nutrition totals</name>
  <files>app/dashboard/actions.ts</files>
  <action>
Create new file `app/dashboard/actions.ts` with Server Action:

1. **getTodayTotals()** - Fetches aggregated nutrition data for today
   - Get current user with `await supabase.auth.getUser()`
   - Return error if not authenticated
   - Query meal_logs table filtering by:
     * user_id (RLS handles this automatically)
     * logged_at >= start of today (use `new Date().setHours(0,0,0,0)`)
     * logged_at < start of tomorrow
   - Aggregate SUM for all nutrition fields: calories, protein, carbs, fat, fiber, sugar, sodium
   - Count total meals logged today
   - Return object: `{ totalMeals: number, calories: number, protein: number, carbs: number, fat: number, fiber: number, sugar: number, sodium: number }`
   - Use `coalesce()` or handle null values (sum may be 0 if no meals)
   - Round numeric values to 1 decimal place for display

**IMPORTANT:** Use Supabase query aggregation, NOT fetching all rows and summing in JS. Example pattern:
```typescript
const { data, error } = await supabase
  .from('meal_logs')
  .select('calories, protein, carbs, fat, fiber, sugar, sodium')
  .gte('logged_at', startOfToday.toISOString())
  .lt('logged_at', startOfTomorrow.toISOString())
```
Then sum in TypeScript (Supabase JS client doesn't have aggregate functions).

**Timezone handling:** Use UTC consistently. Supabase stores timestamps in UTC, JavaScript Date handles local timezone conversion.
  </action>
  <verify>
1. Action exists and exports getTodayTotals function
2. TypeScript compiles without errors
3. Function returns correct structure with all nutrition fields
4. Test manually: Call from dashboard page, verify totals match meals logged today
  </verify>
  <done>
- getTodayTotals Server Action created in app/dashboard/actions.ts
- Function queries meal_logs with today's date filter
- Returns aggregated nutrition totals and meal count
- Handles no meals case (returns zeros)
- TypeScript types defined for return value
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard page with today's totals and progress bars</name>
  <files>app/dashboard/page.tsx, components/dashboard/TodayTotals.tsx, components/dashboard/ProgressBar.tsx</files>
  <action>
**1. Create ProgressBar component** (`components/dashboard/ProgressBar.tsx`):
- Props: `{ label: string, value: number, max: number, unit: string, color?: string }`
- Display label, value/max with unit (e.g., "1500 / 2000 kcal")
- Visual progress bar using Tailwind (relative, overflow-hidden, bg-gray-200 container)
- Fill color based on percentage: green <80%, yellow 80-100%, red >100%
- Percentage width calculated as `(value / max) * 100` capped at 100%
- Show percentage text on bar if >20% width, otherwise beside bar

**2. Create TodayTotals component** (`components/dashboard/TodayTotals.tsx`):
- Server Component (async, fetches data)
- Call `getTodayTotals()` action
- Display in card layout:
  * Heading: "Today's Nutrition" with meal count
  * 4 main macros with ProgressBar components:
    - Calories (goal: 2000 kcal) - blue color
    - Protein (goal: 150g) - purple color
    - Carbs (goal: 250g) - orange color
    - Fat (goal: 67g) - yellow color
  * Optional: Show fiber, sugar, sodium as text (no progress bars)
- If no meals today: Show empty state with "No meals logged today" and "Log your first meal" button
- Use grid layout for responsive design (1 column mobile, 2 columns desktop)

**3. Update dashboard/page.tsx**:
- Replace placeholder content with TodayTotals component
- Keep existing navigation links below (Log New Meal, View All Meals)
- Add heading "Dashboard" with user email
- Use max-width container (max-w-7xl mx-auto)
- Responsive padding (px-4 sm:px-6 lg:px-8)
- Keep clean, modern aesthetic with Tailwind

**IMPORTANT:** Goals are hardcoded for v1 (2000 kcal, 150g protein, 250g carbs, 67g fat). Phase 7 will add user-customizable goals from database.

**Color scheme:**
- Calories: blue-600
- Protein: purple-600
- Carbs: orange-600
- Fat: yellow-600
- Progress bar fill: green-500 (<80%), yellow-500 (80-100%), red-500 (>100%)
  </action>
  <verify>
1. Dashboard page loads without errors
2. Today's totals display correctly (matches database data)
3. Progress bars render with correct percentages
4. Colors change based on progress (green/yellow/red)
5. Empty state shows when no meals logged today
6. Responsive layout works on mobile and desktop
7. TypeScript compiles without errors
  </verify>
  <done>
- ProgressBar component created with color-coded fill
- TodayTotals component created as Server Component
- Dashboard page updated with nutrition totals display
- Progress bars show calories, protein, carbs, fat with hardcoded goals
- Empty state for days with no meals
- Responsive grid layout implemented
- Clean, modern UI with Tailwind styling
  </done>
</task>

<task type="auto">
  <name>Task 3: Add recent meals preview to dashboard</name>
  <files>app/dashboard/actions.ts, components/dashboard/RecentMeals.tsx, app/dashboard/page.tsx</files>
  <action>
**1. Add Server Action** in `app/dashboard/actions.ts`:
- **getRecentMeals(limit: number = 5)** - Fetches most recent meals
  * Get current user with `await supabase.auth.getUser()`
  * Return error if not authenticated
  * Query meal_logs table:
    - Select: id, title, meal_type, logged_at, calories, photo_url
    - Order by logged_at DESC (most recent first)
    - Limit to `limit` parameter (default 5)
  * Return array of meals with type definition

**2. Create RecentMeals component** (`components/dashboard/RecentMeals.tsx`):
- Server Component (async)
- Call `getRecentMeals(5)` to get last 5 meals
- Display in card with heading "Recent Meals"
- Show meal list with:
  * Thumbnail if photo_url exists (50x50px rounded)
  * Meal title
  * Meal type badge (same as meals page - colored pills)
  * Relative time (e.g., "2 hours ago", "Yesterday") using Intl.RelativeTimeFormat or simple date-fns alternative
  * Calories if available ("450 kcal")
- Link each meal to edit page: `/dashboard/meals/${meal.id}/edit`
- If no meals: Show empty state "No meals yet"
- "View all meals" link at bottom â†’ `/dashboard/meals`

**3. Update dashboard/page.tsx**:
- Add RecentMeals component below TodayTotals
- Use grid layout: 2 columns on desktop (totals left, recent meals right), 1 column mobile
- Keep proper spacing and responsive design

**Relative time calculation** (simple approach without date-fns):
```typescript
const getRelativeTime = (date: Date) => {
  const now = new Date()
  const diff = now.getTime() - date.getTime()
  const minutes = Math.floor(diff / 60000)
  const hours = Math.floor(diff / 3600000)
  const days = Math.floor(diff / 86400000)

  if (minutes < 60) return `${minutes}m ago`
  if (hours < 24) return `${hours}h ago`
  if (days === 1) return 'Yesterday'
  if (days < 7) return `${days}d ago`
  return date.toLocaleDateString()
}
```

**Meal type badge colors** (match meals page pattern):
- breakfast: bg-yellow-100 text-yellow-800
- lunch: bg-blue-100 text-blue-800
- dinner: bg-purple-100 text-purple-800
- snack: bg-green-100 text-green-800
  </action>
  <verify>
1. Recent meals display on dashboard
2. Shows last 5 meals ordered by most recent
3. Thumbnails render correctly (or placeholder if no image)
4. Relative time displays correctly ("2h ago", "Yesterday", etc.)
5. Meal type badges render with correct colors
6. Links to meal edit pages work
7. Empty state shows when no meals exist
8. "View all meals" link navigates to meals page
9. Responsive layout works (2-col desktop, 1-col mobile)
  </verify>
  <done>
- getRecentMeals Server Action created
- RecentMeals component displays last 5 meals
- Relative time formatting implemented
- Meal type badges with color coding
- Thumbnail display with fallback
- Links to meal edit pages functional
- "View all meals" link added
- Dashboard page updated with 2-column layout (totals + recent meals)
- Responsive design implemented
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Dashboard page loads and displays today's nutrition totals
- [ ] Progress bars render correctly with color coding (green/yellow/red)
- [ ] Recent meals preview shows last 5 meals with correct data
- [ ] All links work (meal edit, view all meals, log new meal)
- [ ] Empty states display when no data available
- [ ] Responsive design works on mobile and desktop
- [ ] TypeScript compiles without errors
- [ ] No console errors in browser
</verification>

<success_criteria>

- All tasks completed
- Dashboard page shows real nutrition data from database
- Progress bars visually represent daily progress toward goals
- Recent meals preview functional with relative timestamps
- UI is clean, modern, and responsive
- No TypeScript or runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-meals/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Dashboard with Today's Totals Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Server Actions for aggregating today's nutrition totals and fetching recent meals
- Dashboard page with progress bars for calories, protein, carbs, fat
- Recent meals preview with relative timestamps and meal type badges
- Responsive 2-column layout (totals + recent meals)

## Files Created/Modified

- `app/dashboard/actions.ts` - getTodayTotals, getRecentMeals actions
- `components/dashboard/ProgressBar.tsx` - Reusable progress bar component
- `components/dashboard/TodayTotals.tsx` - Today's nutrition display
- `components/dashboard/RecentMeals.tsx` - Recent meals preview
- `app/dashboard/page.tsx` - Updated dashboard layout

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md (Meals page filtering)
</output>
