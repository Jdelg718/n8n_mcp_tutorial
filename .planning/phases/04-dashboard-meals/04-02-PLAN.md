---
phase: 04-dashboard-meals
plan: 02
type: execute
---

<objective>
Add filtering capabilities to meals page: date range, meal type, and search functionality.

Purpose: Enable users to find specific meals quickly and browse their meal history efficiently. Essential for reviewing past nutrition data and editing historical entries.
Output: Enhanced meals page with working filters that update the meal list dynamically without full page reloads.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependency on Plan 04-01:
@.planning/phases/04-dashboard-meals/04-01-SUMMARY.md

# Key files from previous phases:
@app/dashboard/meals/page.tsx
@app/dashboard/meals/actions.ts
@lib/supabase/server.ts
@components/meals/MealForm.tsx

**Tech stack available:**
- Next.js 14 App Router with Server Components
- Supabase client with RLS policies
- TypeScript with Zod validation
- Tailwind CSS for styling
- URL search params for filter state
- Server Actions pattern

**Established patterns:**
- Server Components for data fetching
- RLS policies enforce user isolation
- Query filtering with Supabase query builder
- Datetime handling with logged_at timestamps
- Meal types: breakfast, lunch, dinner, snack

**Constraining decisions:**
- Phase 01: Always use auth.getUser() for auth checks
- Phase 01: RLS policies enforce user_id automatically
- Phase 02: Avoid route groups in Next.js 16
- Keep UI patterns consistent with existing meals page

**Current meals page functionality:**
- Lists all meals for logged-in user
- Shows meal cards with title, description, meal type, timestamp, nutrition summary
- Edit and delete buttons on each meal
- Already has proper RLS enforcement

**Filtering requirements (from PROJECT.md):**
- Date range filter (e.g., "Last 7 days", "Last 30 days", "This month", "Custom range")
- Meal type filter (breakfast, lunch, dinner, snack, or "All")
- Search functionality (search meal titles and descriptions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter components for meals page</name>
  <files>components/meals/MealFilters.tsx</files>
  <action>
Create `components/meals/MealFilters.tsx` as Client Component with filter UI:

**1. Component structure:**
- Use 'use client' directive (needs client interactivity for dropdowns)
- Props: `{ onFilterChange: (filters: FilterState) => void }`
- FilterState type: `{ dateRange: string, mealType: string, search: string }`
- Controlled form inputs with local state
- Call onFilterChange when any filter changes

**2. Date range filter:**
- Select dropdown with options:
  * "All time" (default)
  * "Today"
  * "Yesterday"
  * "Last 7 days"
  * "Last 30 days"
  * "This month"
  * "Last month"
- Store selected value in state
- On change, call onFilterChange with updated filters

**3. Meal type filter:**
- Select dropdown with options:
  * "All types" (default)
  * "Breakfast"
  * "Lunch"
  * "Dinner"
  * "Snack"
- Store selected value in state
- On change, call onFilterChange

**4. Search input:**
- Text input with placeholder "Search meals..."
- Debounce search input (500ms) to avoid excessive updates
- Use useEffect with setTimeout for debounce
- On change (debounced), call onFilterChange

**5. Clear filters button:**
- Button to reset all filters to defaults
- Only show if any filters are active (not all defaults)
- Reset state and call onFilterChange with defaults

**Styling:**
- Flexbox layout, wrap on mobile
- Consistent with existing meal page design
- Use Tailwind form styles (border, rounded, focus states)
- Proper spacing between filter controls
- Mobile-responsive (stack vertically on small screens)

**IMPORTANT:** Use URL search params for filter state persistence (see Task 2). This component just manages UI state and calls callback.
  </action>
  <verify>
1. Filter component renders without errors
2. All dropdowns and search input work
3. onFilterChange callback fires with correct filter values
4. Debounce works (search doesn't fire on every keystroke)
5. Clear filters button resets all fields
6. Responsive layout works on mobile and desktop
7. TypeScript types defined for FilterState
  </verify>
  <done>
- MealFilters component created as Client Component
- Date range dropdown with preset options
- Meal type dropdown with all meal types
- Search input with 500ms debounce
- Clear filters button (conditional rendering)
- Responsive flexbox layout
- FilterState type exported for reuse
  </done>
</task>

<task type="auto">
  <name>Task 2: Update meals page to support filtering with URL search params</name>
  <files>app/dashboard/meals/page.tsx, app/dashboard/meals/actions.ts</files>
  <action>
**1. Update getMeals Server Action** (`app/dashboard/meals/actions.ts`):
- Modify to accept optional filter parameters:
  ```typescript
  export async function getMeals(filters?: {
    dateRange?: string
    mealType?: string
    search?: string
  })
  ```
- Apply filters to Supabase query:
  * **Date range**: Convert preset to start/end dates, filter logged_at
    - "Today": startOfToday to now
    - "Yesterday": startOfYesterday to startOfToday
    - "Last 7 days": 7 days ago to now
    - "Last 30 days": 30 days ago to now
    - "This month": start of current month to now
    - "Last month": start of last month to end of last month
    - "All time": no filter
  * **Meal type**: Filter where meal_type = selected (if not "All types")
  * **Search**: Use `.ilike()` for case-insensitive search on title OR description
    - Pattern: `%${search}%`
    - Combine with `.or()` filter: `title.ilike.%search%,description.ilike.%search%`
- Keep existing ordering (logged_at DESC)
- Return array of meals matching all filters

**2. Update meals page** (`app/dashboard/meals/page.tsx`):
- Convert to use URL search params for filter state
- Extract search params: `searchParams: { dateRange?: string, mealType?: string, search?: string }`
- Pass search params to getMeals(filters)
- Import and render MealFilters component
- Create handleFilterChange function that:
  * Takes FilterState from MealFilters
  * Updates URL search params using `useRouter().push()` with new query string
  * Next.js will re-render page with new params automatically
- Place filters above meal list
- Keep existing meal cards, edit/delete functionality
- Show filter summary (e.g., "Showing 12 meals from Last 7 days, Breakfast")
- Show "No meals found" if filtered results are empty

**Date calculation helpers:**
```typescript
const getDateRange = (preset: string): { start: Date | null, end: Date | null } => {
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())

  switch (preset) {
    case 'today':
      return { start: today, end: null }
    case 'yesterday':
      return { start: new Date(today.getTime() - 86400000), end: today }
    case 'last-7-days':
      return { start: new Date(now.getTime() - 7 * 86400000), end: null }
    // ... more cases
    default:
      return { start: null, end: null } // all time
  }
}
```

**IMPORTANT:** Server Component can't use useRouter. Pattern:
- Meals page is Server Component (fetches data with filters from search params)
- MealFilters is Client Component (handles UI interaction)
- Use form with action pointing to search param update OR render MealFilters as Client Component that updates URL

**Better approach:** Make MealFilters handle URL updates internally:
- Import `useRouter`, `useSearchParams` from 'next/navigation'
- Read current params with useSearchParams()
- On filter change, use router.push() to update URL
- Server Component will re-render automatically

**Search param format:**
- `/dashboard/meals?dateRange=last-7-days&mealType=breakfast&search=chicken`
  </action>
  <verify>
1. Filters component renders on meals page
2. Selecting date range filter updates URL and filters meals
3. Selecting meal type filter updates URL and filters meals
4. Search input updates URL and filters meals (debounced)
5. Multiple filters work together (AND logic)
6. Clear filters resets to showing all meals
7. Browser back button works (URL state preserved)
8. Filter summary shows active filters
9. Empty state shows when no meals match filters
10. Existing edit/delete functionality still works
  </verify>
  <done>
- getMeals Server Action updated with filter support
- Date range filtering implemented with preset calculations
- Meal type filtering implemented
- Search filtering with case-insensitive ILIKE
- Meals page updated to use URL search params
- MealFilters component integrated with URL state
- Filter summary display showing active filters
- Empty state for filtered results
- Browser back/forward navigation works
- All existing functionality preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Add pagination for meals list</name>
  <files>app/dashboard/meals/actions.ts, app/dashboard/meals/page.tsx, components/meals/Pagination.tsx</files>
  <action>
**1. Update getMeals action** to support pagination:
- Add parameters: `page: number = 1, pageSize: number = 20`
- Calculate offset: `(page - 1) * pageSize`
- Add `.range(offset, offset + pageSize - 1)` to Supabase query
- Also fetch total count for pagination info:
  ```typescript
  const { count } = await supabase
    .from('meal_logs')
    .select('*', { count: 'exact', head: true })
    ./* apply same filters */
  ```
- Return: `{ meals: Meal[], total: number, page: number, pageSize: number }`

**2. Create Pagination component** (`components/meals/Pagination.tsx`):
- Client Component with props: `{ page: number, totalPages: number, onPageChange: (page: number) => void }`
- Display: "Page X of Y"
- Previous button (disabled on page 1)
- Next button (disabled on last page)
- Page numbers (show first, last, and 2 pages around current)
- Example: [1] ... [4] [5] [6] ... [12]
- On page change, call onPageChange callback
- Use Tailwind for styling (button states, disabled, active page highlight)

**3. Update meals page**:
- Extract page from search params (default to 1)
- Pass page to getMeals(filters, page)
- Calculate totalPages = Math.ceil(total / pageSize)
- Render Pagination component below meal list
- onPageChange updates URL with new page param
- Show "Showing X-Y of Z meals" summary above list

**Pagination URL pattern:**
- `/dashboard/meals?page=2&dateRange=last-7-days&mealType=breakfast`

**Edge cases:**
- If filtered results have fewer than pageSize items, hide pagination
- If page param > totalPages, show page 1 (handle invalid URLs)
- Preserve all filters when changing pages

**Mobile-responsive pagination:**
- On mobile: Show only Prev/Next buttons with "Page X of Y" text
- On desktop: Show full page numbers
  </action>
  <verify>
1. Pagination controls render below meal list
2. Page navigation works (Previous, Next, page numbers)
3. URL updates with page parameter
4. Meals list updates when page changes
5. Filtering resets to page 1
6. "Showing X-Y of Z meals" displays correctly
7. Previous/Next buttons disable appropriately
8. Invalid page numbers redirect to page 1
9. Responsive design (simplified on mobile)
10. TypeScript compiles without errors
  </verify>
  <done>
- getMeals action updated with pagination support
- Total count fetched for pagination calculation
- Pagination component created with page controls
- Meals page integrated pagination with URL state
- "Showing X-Y of Z" summary display
- Filter changes reset to page 1
- Responsive pagination (full on desktop, simple on mobile)
- All edge cases handled (invalid pages, empty results)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All filters work correctly (date range, meal type, search)
- [ ] Filters combine properly (AND logic)
- [ ] URL search params preserve filter state
- [ ] Browser back/forward navigation works
- [ ] Pagination controls display and function
- [ ] Filter changes reset to page 1
- [ ] Empty states show when appropriate
- [ ] Responsive design works on mobile and desktop
- [ ] TypeScript compiles without errors
- [ ] No console errors or warnings
</verification>

<success_criteria>

- All tasks completed
- Meals page has functional filtering (date, meal type, search)
- Pagination implemented with page size of 20
- URL state management works for filters and pagination
- Browser navigation preserved (back/forward buttons work)
- UI is responsive and matches existing design patterns
- No TypeScript or runtime errors
- Phase 4 complete - ready for Phase 5 (Analytics)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-meals/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Meals Page Filtering & Pagination Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Date range filtering with preset options (Today, Last 7 days, etc.)
- Meal type filtering (breakfast, lunch, dinner, snack, all)
- Search functionality with debounced input
- Pagination with 20 meals per page
- URL state management for all filters and pagination
- Browser back/forward navigation support

## Files Created/Modified

- `components/meals/MealFilters.tsx` - Filter UI component
- `components/meals/Pagination.tsx` - Pagination controls
- `app/dashboard/meals/actions.ts` - Updated getMeals with filters and pagination
- `app/dashboard/meals/page.tsx` - Integrated filters, pagination, URL state

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 4 complete. Dashboard and meals pages fully functional with real-time data and filtering.

Ready for Phase 5: Analytics & Insights (charts, trends, AI-generated insights)
</output>
