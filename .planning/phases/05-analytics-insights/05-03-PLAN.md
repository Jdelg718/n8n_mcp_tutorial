---
phase: 05-analytics-insights
plan: 03
type: execute
---

<objective>
Add AI-powered nutrition insights that analyze patterns and provide personalized recommendations.

Purpose: Help users understand their nutrition patterns through AI analysis, identifying trends, issues, and opportunities for improvement.
Output: AI insights panel with pattern analysis, actionable recommendations, and regenerate functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work - this phase
@.planning/phases/05-analytics-insights/05-01-SUMMARY.md
@.planning/phases/05-analytics-insights/05-02-SUMMARY.md

# Existing AI integration patterns from Phase 2
@app/api/ai/analyze/route.ts
@lib/ai/openrouter.ts
@lib/ai/parsers.ts

**Tech stack available:**
- OpenRouter API configured with GPT-4o-mini for text analysis
- Existing parseNutritionResponse() helper in lib/ai/parsers.ts
- Server Actions pattern for data aggregation
- API route pattern for AI processing with loading states

**AI integration patterns from Phase 2:**
- API route (not Server Action) for AI analysis to enable client loading states
- GPT-4o-mini model for cost-effective text analysis
- Structured JSON output with response_format
- Auth check via createClient().auth.getUser()
- Handle 3-10s processing time with loading UI

**Constraining decisions from Phase 4:**
- Hardcoded nutrition goals (2000 kcal, 150g protein, 250g carbs, 67g fat)
- Use these goals in AI analysis context for relevant insights
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI insights generation API route</name>
  <files>app/api/ai/insights/route.ts, lib/ai/parsers.ts</files>
  <action>
  1. Create app/api/ai/insights/route.ts as POST endpoint (follow Phase 2 pattern):
     - Auth check: const { data: { user } } = await supabase.auth.getUser()
     - Accept body: { startDate: string, endDate: string }
     - Fetch meal data for date range (all meals with nutrition data)
     - Calculate patterns: total meals, avg calories/day, macro ratios, day-of-week patterns, meal timing patterns
     - Build AI prompt with:
       - User's nutrition data summary (totals, averages, patterns)
       - Hardcoded goals (2000 kcal, 150g protein, 250g carbs, 67g fat)
       - Ask for: pattern analysis, progress assessment, specific recommendations, potential concerns
     - Call OpenRouter with GPT-4o-mini (like Phase 2)
     - Use structured JSON output: { insights: string[], recommendations: string[], concerns: string[] }
     - Return parsed AI response
  2. Add parseInsightsResponse() to lib/ai/parsers.ts with Zod schema validation
  3. Handle errors gracefully with fallback message
  4. Set 30s timeout for AI response (longer than meal analysis due to more complex data)
  </action>
  <verify>POST to /api/ai/insights with date range returns structured insights JSON, auth check works, errors return 401/500 appropriately</verify>
  <done>AI insights API route created, accepts date range, analyzes meal patterns, returns structured insights/recommendations/concerns</done>
</task>

<task type="auto">
  <name>Task 2: Build InsightsPanel component with AI analysis display</name>
  <files>components/analytics/InsightsPanel.tsx</files>
  <action>
  1. Create components/analytics/InsightsPanel.tsx as Client Component ("use client"):
     - Props: startDate and endDate from parent
     - State: insights (null | { insights: string[], recommendations: string[], concerns: string[] }), loading (boolean), error (string | null)
     - useEffect to fetch insights on mount or when date range changes
     - Fetch from /api/ai/insights with current date range
     - Display loading state: "Analyzing your nutrition patterns..." with spinner (3-10s wait)
     - Display insights in 3 sections:
       - "Insights" section: List of pattern observations with lightbulb icon
       - "Recommendations" section: Actionable suggestions with checkmark icon
       - "Concerns" section: Potential issues with warning icon (only if present)
     - Each item in styled card/list with icon, text, subtle background color
     - "Regenerate Insights" button to re-fetch analysis
  2. Wrap in card container with title "AI Nutrition Analysis" and subtitle "Based on your recent meals"
  3. Handle empty state: "Not enough data for AI analysis. Log more meals to see insights."
  4. Handle error state: "Failed to generate insights. Try again." with retry button
  5. Follow Phase 2 loading state patterns (loading spinner, disabled state)
  </action>
  <verify>InsightsPanel fetches AI analysis, displays structured insights/recommendations/concerns, loading state shows during fetch, regenerate button works</verify>
  <done>InsightsPanel component displays AI-generated nutrition insights with loading states, error handling, and regenerate functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate InsightsPanel into analytics page with polish</name>
  <files>app/dashboard/analytics/page.tsx, components/analytics/InsightsPanel.tsx</files>
  <action>
  1. Add InsightsPanel to analytics page.tsx below charts section:
     - Full width section (not in charts grid)
     - Pass startDate and endDate as props
     - Panel updates when time range changes (dates are props)
  2. Add visual polish to InsightsPanel:
     - Icons for each section (use Tailwind or emoji: üí° insights, ‚úÖ recommendations, ‚ö†Ô∏è concerns)
     - Color-coded sections: blue for insights, green for recommendations, yellow/red for concerns
     - Smooth transitions on load/update
     - Consistent spacing and typography with rest of analytics page
  3. Add "Last updated" timestamp below insights (updated when generated)
  4. Optional: Add collapse/expand functionality to save space
  5. Ensure mobile responsive: insights stack vertically, readable on small screens
  6. Test complete analytics page flow: change time range ‚Üí charts update ‚Üí insights regenerate
  </action>
  <verify>InsightsPanel integrated into analytics page, updates with time range changes, visual design is polished and consistent, mobile layout works</verify>
  <done>Complete analytics page with summary stats, trend charts, and AI-generated insights all responding to time range selection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] AI insights API generates relevant pattern analysis
- [ ] InsightsPanel displays insights in structured format with icons
- [ ] Loading state shows during AI processing (3-10s)
- [ ] Regenerate button refetches new insights
- [ ] Insights update when time range selector changes
- [ ] Complete analytics page provides comprehensive nutrition analysis
- [ ] All components are mobile responsive
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- AI insights provide actionable nutrition guidance
- Complete analytics page ready for Phase 5 completion
- Phase complete: Analytics page with time ranges, charts, and AI insights
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics-insights/05-03-SUMMARY.md`:

# Phase 5 Plan 3: AI-Generated Insights Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 5 complete! Analytics page provides comprehensive nutrition analysis with:
- Time range selector (Today, 7d, 30d, 90d, All Time)
- Summary statistics (total meals, averages)
- Calorie trends line chart
- Macro distribution pie chart
- AI-generated pattern insights and recommendations

Ready for Phase 6: Health App Integration (Terra API setup, Apple Health/Google Fit sync)
</output>
