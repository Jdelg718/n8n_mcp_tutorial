---
phase: 01-foundation-database
plan: 03
type: execute
---

<objective>
Implement complete authentication system with email/password signup, OAuth providers (Google, Apple), and protected route middleware.

Purpose: Enable user registration and login via multiple methods, securing the application with session management and token refresh.
Output: Working authentication with signup, login, OAuth, callback handling, and protected dashboard layout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/DISCOVERY.md
@.planning/phases/01-foundation-database/01-01-SUMMARY.md
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication Server Actions for signup and login</name>
  <files>app/actions/auth.ts, lib/zod/schemas.ts</files>
  <action>
    Create Server Actions following DISCOVERY.md section 2.D (Authentication Flow) and 2.C (Server Actions Pattern):

    1. **lib/zod/schemas.ts** - Validation schemas:
       ```typescript
       export const SignUpSchema = z.object({
         email: z.string().email('Invalid email address'),
         password: z.string().min(8, 'Password must be at least 8 characters'),
         full_name: z.string().min(1, 'Name is required'),
       })

       export const SignInSchema = z.object({
         email: z.string().email('Invalid email address'),
         password: z.string().min(1, 'Password is required'),
       })
       ```

    2. **app/actions/auth.ts** - Server Actions (mark with 'use server'):
       - **signUp(prevState, formData)**:
         - Validate with SignUpSchema
         - Call supabase.auth.signUp() with email, password, and full_name in metadata
         - Set emailRedirectTo for verification callback
         - Return { error } or redirect('/dashboard') on success
       - **signIn(prevState, formData)**:
         - Validate with SignInSchema
         - Call supabase.auth.signInWithPassword()
         - Return { error } or redirect('/dashboard') on success
       - **signOut()**:
         - Call supabase.auth.signOut()
         - Redirect to '/login'

    IMPORTANT: Always use createClient from lib/supabase/server (NOT client). Never expose service_role key. Use exact patterns from DISCOVERY.md sections 2.C and 2.D.1 to avoid auth issues.
  </action>
  <verify>
    - Check app/actions/auth.ts exists with 'use server' directive
    - Check lib/zod/schemas.ts exports both schemas
    - Run `npm run build` and verify no TypeScript errors
    - Verify Server Actions import from lib/supabase/server (not client)
  </verify>
  <done>
    - Server Actions created for signup, login, and logout
    - Input validation with Zod schemas
    - Proper error handling and redirects
    - Ready for UI forms to call these actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create authentication pages with forms and OAuth buttons</name>
  <files>app/(auth)/login/page.tsx, app/(auth)/signup/page.tsx, app/(auth)/layout.tsx, components/auth/LoginForm.tsx, components/auth/SignUpForm.tsx, components/auth/OAuthButtons.tsx</files>
  <action>
    Create authentication UI with forms that use Server Actions:

    1. **app/(auth)/layout.tsx** - Simple centered layout for auth pages:
       - Centered container with max-width
       - No navigation (public pages)

    2. **components/auth/SignUpForm.tsx** - Client Component:
       - Use useActionState hook with signUp action
       - Form fields: email, password, full_name
       - Display validation errors from state.errors
       - Show loading state with isPending
       - Use exact pattern from DISCOVERY.md section 2.C (Using Server Actions in Forms)

    3. **components/auth/LoginForm.tsx** - Client Component:
       - Use useActionState hook with signIn action
       - Form fields: email, password
       - Display validation errors and auth errors
       - Show loading state

    4. **components/auth/OAuthButtons.tsx** - Client Component:
       - Import createClient from lib/supabase/client (browser client)
       - Create buttons for Google and Apple
       - Call signInWithOAuth({ provider: 'google'/'apple', options: { redirectTo: origin/auth/callback } })
       - Use exact pattern from DISCOVERY.md section 2.D.2 (OAuth implementation)

    5. **app/(auth)/signup/page.tsx** - Server Component:
       - Import SignUpForm and OAuthButtons
       - Simple page with heading, form, divider, OAuth buttons
       - Link to login page

    6. **app/(auth)/login/page.tsx** - Server Component:
       - Import LoginForm and OAuthButtons
       - Simple page with heading, form, divider, OAuth buttons
       - Link to signup page

    Use basic Tailwind styling (clean, minimal). Focus on functionality over design polish.
  </action>
  <verify>
    - Run `npm run dev` and visit /login
    - Check that login form renders without errors
    - Check that signup form renders at /signup
    - Verify OAuth buttons render (functionality tested in next task)
    - Run `npm run build` to verify no TypeScript errors
  </verify>
  <done>
    - Login and signup pages created with working forms
    - Forms connected to Server Actions
    - OAuth buttons created (not yet functional - needs Supabase config)
    - Validation errors display properly
    - Loading states implemented
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure OAuth providers in Supabase Dashboard</action>
  <instructions>
    I've created the authentication UI with OAuth buttons, but OAuth providers must be configured in the Supabase Dashboard before they work.

    **Steps to configure OAuth:**

    1. **Open Supabase Dashboard:**
       - Go to https://supabase.com/dashboard
       - Select your project

    2. **Enable Google OAuth:**
       - Navigate to Authentication > Providers
       - Find "Google" and click "Enable"
       - Get credentials:
         - Visit Google Cloud Console (console.cloud.google.com)
         - Create OAuth 2.0 Client ID (or use existing)
         - Add authorized redirect URI: `https://[your-project-ref].supabase.co/auth/v1/callback`
       - Paste Client ID and Client Secret into Supabase
       - Save

    3. **Enable Apple OAuth:**
       - Navigate to Authentication > Providers
       - Find "Apple" and click "Enable"
       - Get credentials:
         - Visit Apple Developer portal (developer.apple.com)
         - Create Sign in with Apple configuration
         - Add redirect URI: `https://[your-project-ref].supabase.co/auth/v1/callback`
       - Paste Service ID and Private Key into Supabase
       - Save

    **Note:** OAuth configuration is optional for testing. Email/password auth works without this step. You can configure OAuth later if needed.

    Refer to DISCOVERY.md section 2.D.2 for detailed OAuth setup instructions.
  </instructions>
  <verification>
    I'll create the auth callback route and test authentication functionality after you indicate OAuth is configured (or skipped).
  </verification>
  <resume-signal>Type "configured" if OAuth is set up, or "skip" to proceed with email/password only</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create OAuth callback route and protected dashboard layout</name>
  <files>app/auth/callback/route.ts, app/(dashboard)/layout.tsx, app/(dashboard)/page.tsx, app/(dashboard)/profile/page.tsx</files>
  <action>
    Complete authentication system with callback handling and protected routes:

    1. **app/auth/callback/route.ts** - OAuth callback handler:
       - GET handler that extracts code from searchParams
       - Call supabase.auth.exchangeCodeForSession(code)
       - Redirect to /dashboard on success, /auth/error on failure
       - Use exact pattern from DISCOVERY.md section 2.D.2 (Auth callback handler)

    2. **app/(dashboard)/layout.tsx** - Protected dashboard layout:
       - Server Component that checks authentication
       - Call createClient from lib/supabase/server
       - Call supabase.auth.getUser() (NOT getSession - see DISCOVERY.md pitfall 1)
       - If no user, redirect to /login
       - Render children if authenticated
       - Add simple nav with Sign Out button (calls signOut Server Action)

    3. **app/(dashboard)/page.tsx** - Dashboard home:
       - Server Component with simple welcome message
       - Display user email from authenticated user
       - Placeholder for dashboard content (will be built in Phase 4)

    4. **app/(dashboard)/profile/page.tsx** - Basic profile page:
       - Fetch user profile from profiles table
       - Display full_name, email, avatar_url
       - Link to edit profile (placeholder)

    IMPORTANT: Use auth.getUser() NOT auth.getSession() in all Server Components (DISCOVERY.md pitfall 1). Always re-authorize before fetching user data.
  </action>
  <verify>
    - Run `npm run dev`
    - Visit /dashboard without being logged in → should redirect to /login
    - Sign up with test email → should redirect to /dashboard
    - Check that user email displays on dashboard
    - Click Sign Out → should redirect to /login
    - Test OAuth flow if configured (click Google/Apple button, authorize, should redirect back)
  </verify>
  <done>
    - OAuth callback route handles authorization code exchange
    - Protected dashboard layout enforces authentication
    - Dashboard home displays user data
    - Profile page shows user profile from database
    - Sign out functionality works
    - Phase 1 authentication complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Sign up with email/password works
- [ ] Login with email/password works
- [ ] OAuth providers work (if configured) or skipped
- [ ] Protected routes redirect unauthenticated users
- [ ] Sign out clears session and redirects
- [ ] User profile auto-created in database (check profiles table)
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Complete authentication system functional
- Users can register, login, and access protected dashboard
- RLS policies working (users only see their own data)
- OAuth configured or skipped with understanding
- Phase 1 complete and ready for Phase 2
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Authentication System Summary

**Complete authentication with email/password signup, OAuth providers, protected routes, and dashboard layout**

## Accomplishments

- Created Server Actions for signup, login, and logout with Zod validation
- Built authentication forms using useActionState hook pattern
- Implemented OAuth buttons for Google and Apple sign-in
- Created OAuth callback route for authorization code exchange
- Built protected dashboard layout with auth checks
- Added profile page displaying user data from database
- Verified RLS policies working (auto-profile creation on signup)

## Files Created/Modified

- `app/actions/auth.ts` - Authentication Server Actions
- `lib/zod/schemas.ts` - Validation schemas
- `components/auth/LoginForm.tsx` - Login form component
- `components/auth/SignUpForm.tsx` - Signup form component
- `components/auth/OAuthButtons.tsx` - OAuth provider buttons
- `app/(auth)/login/page.tsx` - Login page
- `app/(auth)/signup/page.tsx` - Signup page
- `app/(auth)/layout.tsx` - Auth pages layout
- `app/auth/callback/route.ts` - OAuth callback handler
- `app/(dashboard)/layout.tsx` - Protected dashboard layout
- `app/(dashboard)/page.tsx` - Dashboard home
- `app/(dashboard)/profile/page.tsx` - User profile page

## Decisions Made

- Used Server Actions instead of API routes for auth mutations
- Implemented useActionState for form handling with loading states
- OAuth providers configured in Supabase Dashboard (or skipped for email-only)
- Used auth.getUser() everywhere (never getSession) to avoid stale sessions
- Protected routes at layout level for entire dashboard section

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 1 complete!** The foundation is solid:
- ✅ Next.js 14 with App Router configured
- ✅ Supabase client utilities for all contexts
- ✅ Database schema with RLS policies
- ✅ Authentication system fully functional
- ✅ Protected routes enforcing authorization

Ready for Phase 2: Meal Logging System. Users can now sign up and authenticate, and the database is ready to store meal data with proper security isolation.

## Next Step

Phase 2: Meal Logging System - Build meal entry forms, image uploads, and AI-powered nutrition analysis.
</output>
