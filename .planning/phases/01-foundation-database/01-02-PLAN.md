---
phase: 01-foundation-database
plan: 02
type: execute
---

<objective>
Create complete database schema with all tables, Row Level Security policies, indexes, and triggers for the meal tracking application.

Purpose: Establish secure, performant database foundation that enforces multi-tenant isolation at the database level.
Output: Production-ready Supabase database schema with RLS policies tested and verified.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/DISCOVERY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration with all tables, RLS policies, and indexes</name>
  <files>supabase/migrations/20260111_initial_schema.sql</files>
  <action>
    Create a comprehensive SQL migration file following DISCOVERY.md section 11 (Migration Strategy):

    **Tables to create (in order):**
    1. **profiles** - Extends auth.users with app-specific fields
       - id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
       - username TEXT UNIQUE
       - full_name TEXT
       - avatar_url TEXT
       - timezone TEXT DEFAULT 'UTC'
       - created_at, updated_at TIMESTAMPTZ

    2. **meal_logs** - Core meal tracking data
       - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
       - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
       - title TEXT NOT NULL
       - description TEXT
       - calories INTEGER
       - protein, carbs, fat DECIMAL(5,2)
       - fiber, sugar, sodium DECIMAL(5,2)
       - logged_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       - meal_type TEXT CHECK (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack'))
       - photo_url TEXT
       - source TEXT DEFAULT 'manual' CHECK (source IN ('manual', 'telegram_text', 'telegram_image', 'web'))
       - ai_confidence DECIMAL(3,2)
       - created_at, updated_at TIMESTAMPTZ

    3. **health_data** - Health metrics from Terra API and manual entry
       - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
       - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
       - weight, height, bmi DECIMAL(5,2)
       - blood_pressure_systolic, blood_pressure_diastolic INTEGER
       - heart_rate INTEGER
       - steps INTEGER
       - active_calories, resting_calories INTEGER
       - exercise_minutes INTEGER
       - distance DECIMAL(6,2)
       - data_source TEXT CHECK (data_source IN ('manual', 'apple_health', 'google_fit'))
       - recorded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       - created_at TIMESTAMPTZ DEFAULT NOW()

    4. **goals** - User nutrition and health goals
       - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
       - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
       - goal_type TEXT NOT NULL CHECK (goal_type IN ('calorie', 'protein', 'carbs', 'fat', 'weight', 'exercise', 'custom'))
       - target_value DECIMAL(10,2) NOT NULL
       - current_value DECIMAL(10,2)
       - start_date DATE NOT NULL
       - end_date DATE
       - status TEXT DEFAULT 'active' CHECK (status IN ('active', 'completed', 'cancelled'))
       - created_at, updated_at TIMESTAMPTZ

    **For EACH table:**
    - Enable RLS: `ALTER TABLE [table] ENABLE ROW LEVEL SECURITY;`
    - Create policies for SELECT, INSERT, UPDATE, DELETE (authenticated users, own data only)
    - Use pattern: `USING ((SELECT auth.uid()) = user_id)` for performance
    - Add WITH CHECK for INSERT/UPDATE policies
    - Create indexes on: user_id, logged_at/recorded_at (DESC), composite (user_id, date DESC)

    **Important:**
    - Use exact RLS policy patterns from DISCOVERY.md section 3 to avoid security issues
    - Wrap auth.uid() in SELECT for performance (section 3 Performance Optimization)
    - Specify `TO authenticated` on all policies
    - Add CHECK constraints for enum-like columns

    DO NOT create triggers yet (next task). DO NOT run migration yet (we'll test first).
  </action>
  <verify>
    - Check migration file exists at supabase/migrations/20260111_initial_schema.sql
    - Count tables: should define 4 CREATE TABLE statements
    - Count RLS: should have 4 ALTER TABLE ENABLE RLS statements
    - Count policies: should have ~16 policies (4 CRUD operations Ã— 4 tables)
    - Count indexes: should have ~12 CREATE INDEX statements
    - Verify no syntax errors by reviewing SQL
  </verify>
  <done>
    - Migration file created with all 4 tables
    - RLS enabled on all tables
    - All CRUD policies created with correct patterns
    - Indexes created on foreign keys and frequently queried columns
    - CHECK constraints on enum columns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auto-profile trigger and apply migration to Supabase</name>
  <files>supabase/migrations/20260111_initial_schema.sql (append), .env.local (update with actual values)</files>
  <action>
    1. **Add trigger to migration file** (append to existing file):
       - Create function `public.handle_new_user()` that inserts into profiles table on auth.users INSERT
       - Use SECURITY DEFINER and SET search_path = '' for security
       - Extract full_name and avatar_url from raw_user_meta_data
       - Create trigger `on_auth_user_created` AFTER INSERT ON auth.users
       - Use exact pattern from DISCOVERY.md section 4 (Profiles Table)

    2. **Update .env.local** with actual Supabase credentials:
       - Get URL and anon key from Supabase project dashboard
       - Paste into NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
       - Verify format: URL should be https://[project-ref].supabase.co

    3. **Apply migration to Supabase**:
       - Run migration via Supabase SQL Editor (copy/paste entire migration file)
       - OR use Supabase CLI if available: `npx supabase db push` (requires supabase init first)
       - Verify no errors in SQL execution

    4. **Test RLS policies** in Supabase SQL Editor:
       ```sql
       -- Create test user (if needed)
       -- SET request.jwt.claim.sub = 'test-user-uuid';

       -- Test meal_logs SELECT policy (should return empty)
       SELECT * FROM meal_logs;

       -- Test meal_logs INSERT policy
       INSERT INTO meal_logs (user_id, title, calories) VALUES ((SELECT auth.uid()), 'Test Meal', 500);

       -- Verify policy isolation (try with different user UUID)
       ```

    IMPORTANT: RLS policies MUST be tested before proceeding. If policies fail, do not continue - fix them first.
  </action>
  <verify>
    - Migration applied successfully in Supabase (no SQL errors)
    - All 4 tables visible in Supabase Table Editor
    - RLS enabled indicator shows on each table
    - Trigger exists: check in Database > Triggers
    - Test query returns expected results (isolation works)
  </verify>
  <done>
    - Auto-profile trigger created and working
    - Migration successfully applied to Supabase project
    - RLS policies tested and verified to isolate user data
    - Database ready for authentication implementation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 tables exist in Supabase
- [ ] RLS enabled on all tables (check Table Editor)
- [ ] RLS policies tested with sample queries
- [ ] Auto-profile trigger exists in Database > Triggers
- [ ] Environment variables contain actual Supabase credentials
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Database schema matches requirements from PROJECT.md
- RLS policies enforce user data isolation
- Indexes created for performance
- Trigger automatically creates profile on signup
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Database Schema & Security Summary

**Complete database schema with 4 tables, RLS policies, indexes, and auto-profile trigger deployed to Supabase**

## Accomplishments

- Created comprehensive SQL migration with all required tables
- Enabled Row Level Security on all tables
- Implemented RLS policies for multi-tenant data isolation
- Added indexes on foreign keys and query patterns
- Created trigger for automatic profile creation on signup
- Tested RLS policies to verify security isolation

## Files Created/Modified

- `supabase/migrations/20260111_initial_schema.sql` - Complete database schema
- `.env.local` - Updated with actual Supabase credentials

## Tables Created

- `profiles` - User profile extensions (4 policies, 1 index, 1 trigger)
- `meal_logs` - Meal tracking data (4 policies, 3 indexes)
- `health_data` - Health metrics (2 policies, 2 indexes)
- `goals` - User goals (1 FOR ALL policy, 2 indexes)

## Decisions Made

- Used wrapped `(SELECT auth.uid())` pattern for RLS performance optimization
- Added CHECK constraints on enum-like columns for data integrity
- Created composite indexes on (user_id, date DESC) for common query patterns
- Included all planned nutrition fields (fiber, sugar, sodium) and health metrics in schema

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Database foundation complete.** Next plan should implement authentication UI and middleware to enable user signups and logins that will use these tables.

## Next Step

Ready for Plan 3: Authentication System (01-03-PLAN.md)
</output>
