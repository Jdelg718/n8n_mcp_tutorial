---
phase: 01-foundation-database
plan: 01
type: execute
---

<objective>
Set up Next.js 14 project with App Router and configure Supabase client utilities for browser, server, and middleware contexts.

Purpose: Establish the core infrastructure and client configuration patterns that all features depend on.
Output: Working Next.js app with TypeScript, Supabase clients properly configured, and environment variables set up.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database/DISCOVERY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 14 project with dependencies</name>
  <files>package.json, .env.local, .env.example, .gitignore, tsconfig.json</files>
  <action>
    1. Run `npx create-next-app@latest meal-tracker --typescript --tailwind --app --no-src-dir` in the current directory (this creates a subdirectory)
    2. Move all files from meal-tracker/ to project root (mv meal-tracker/* . && mv meal-tracker/.* . 2>/dev/null || true && rmdir meal-tracker)
    3. Install Supabase dependencies: `npm install @supabase/supabase-js @supabase/ssr zod`
    4. Create .env.local with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY (empty values with comments)
    5. Create .env.example with same variables but no values
    6. Ensure .env.local is in .gitignore

    IMPORTANT: Use @supabase/ssr (NOT deprecated auth-helpers packages). Never commit .env.local to git.
  </action>
  <verify>
    - Run `npm run dev` and verify Next.js starts without errors
    - Check that .env.local exists and is gitignored
    - Run `npm list @supabase/ssr @supabase/supabase-js zod` to verify packages installed
  </verify>
  <done>
    - Next.js 14 app runs on localhost:3000
    - All Supabase packages installed
    - Environment variable files created
    - TypeScript configured with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase client utilities for browser, server, and middleware</name>
  <files>lib/supabase/client.ts, lib/supabase/server.ts, lib/supabase/middleware.ts, middleware.ts</files>
  <action>
    Create three distinct Supabase client utilities following DISCOVERY.md patterns:

    1. **lib/supabase/client.ts** - Browser client for Client Components:
       - Use createBrowserClient from @supabase/ssr
       - Takes NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
       - Export createClient() function

    2. **lib/supabase/server.ts** - Server client for Server Components/Actions:
       - Use createServerClient from @supabase/ssr
       - Import cookies from 'next/headers'
       - Implement cookie handlers with getAll() and setAll()
       - Handle try/catch in setAll (fails in Server Components, expected)
       - Export async createClient() function

    3. **lib/supabase/middleware.ts** - Middleware client for token refresh:
       - Use createServerClient from @supabase/ssr
       - Implement cookie handlers for request/response
       - Call supabase.auth.getUser() to refresh session
       - Export async updateSession(request: NextRequest) function

    4. **middleware.ts** (root) - Next.js middleware:
       - Import updateSession from lib/supabase/middleware
       - Call updateSession in middleware function
       - Configure matcher to exclude static files: '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'

    Use exact patterns from DISCOVERY.md sections 2.A.1, 2.A.2, 2.A.3 to avoid auth issues. Never use deprecated auth-helpers patterns.
  </action>
  <verify>
    - Check all 4 files exist with correct exports
    - Run `npm run build` and verify no TypeScript errors
    - Check middleware.ts exports middleware function and config
  </verify>
  <done>
    - Three Supabase client utilities created with correct patterns
    - Root middleware configured for token refresh
    - No TypeScript errors
    - Ready for authentication implementation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` starts successfully
- [ ] All Supabase client files exist with proper exports
- [ ] Environment variables configured (even if empty)
- [ ] Middleware configured with correct matcher
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Next.js app builds and runs
- Supabase client utilities follow recommended patterns from discovery
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Project Setup & Supabase Configuration Summary

**Next.js 14 project initialized with Supabase SSR client utilities configured for browser, server, and middleware contexts**

## Accomplishments

- Next.js 14 App Router project created with TypeScript and Tailwind
- Supabase packages installed (@supabase/ssr, @supabase/supabase-js, zod)
- Three Supabase client utilities created following best practices
- Root middleware configured for automatic token refresh
- Environment variables structure established

## Files Created/Modified

- `package.json` - Dependencies and scripts
- `lib/supabase/client.ts` - Browser client for Client Components
- `lib/supabase/server.ts` - Server client for Server Components/Actions
- `lib/supabase/middleware.ts` - Middleware client for token refresh
- `middleware.ts` - Root middleware for auth
- `.env.local` - Environment variables (not committed)
- `.env.example` - Template for env vars

## Decisions Made

- Using @supabase/ssr (latest recommended approach, not deprecated auth-helpers)
- Middleware configured to refresh tokens on all routes except static files
- TypeScript strict mode enabled by default

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 2: Database Schema & Security (01-02-PLAN.md)
</output>
