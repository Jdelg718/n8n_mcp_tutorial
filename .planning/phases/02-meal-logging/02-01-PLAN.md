---
phase: 02-meal-logging
plan: 01
type: execute
---

<objective>
Set up infrastructure for meal logging: Supabase Storage bucket for meal images and OpenRouter AI client for nutrition analysis.

Purpose: Establish the foundational services that all meal logging features depend on.
Output: Configured storage bucket with RLS policies, OpenRouter client utility, and AI prompt templates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-meal-logging/02-RESEARCH.md
@.planning/phases/01-foundation-database/01-01-SUMMARY.md
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
@lib/supabase/server.ts
@supabase/migrations/20260111_initial_schema.sql

**Tech stack available:**
- @supabase/ssr for client utilities
- Zod for validation
- Next.js 14 App Router with Server Components

**Established patterns:**
- RLS Pattern: Use (SELECT auth.uid()) wrapped for performance
- Server Actions pattern with Zod validation
- Environment variables with .env.local

**Constraining decisions:**
- Phase 01: Using @supabase/ssr (latest recommended approach)
- Phase 01: Always use auth.getUser() never getSession()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Storage bucket and RLS policies</name>
  <files>supabase/storage_setup.sql</files>
  <action>
Create SQL migration for Supabase Storage:

1. Create 'meal-images' bucket with public access for authenticated users
2. Add RLS policies:
   - INSERT: Users can only upload to their own folder (user_id/filename pattern)
   - SELECT: Users can only view their own images
   - UPDATE: Users can update their own images
   - DELETE: Users can delete their own images
3. Configure max file size (10MB) and allowed MIME types (image/jpeg, image/png, image/webp)

Apply via Supabase Dashboard SQL Editor (copy/paste migration).

IMPORTANT: Use folder pattern storage.foldername(name)[1] = (SELECT auth.uid())::text for RLS path-based security. See RESEARCH.md for signed URL upload pattern.
  </action>
  <verify>Check in Supabase Dashboard: Storage > meal-images bucket exists, RLS policies visible, test upload via Dashboard interface</verify>
  <done>Bucket exists with RLS enabled, policies prevent cross-user access, authenticated users can upload to their folder</done>
</task>

<task type="auto">
  <name>Task 2: Create OpenRouter AI client and prompt templates</name>
  <files>lib/ai/openrouter.ts, lib/ai/prompts.ts, lib/ai/types.ts, .env.local, .env.example</files>
  <action>
Create OpenRouter client infrastructure:

**lib/ai/openrouter.ts:**
- Import OpenAI SDK (already installed: compatible with OpenRouter)
- Create client with baseURL: 'https://openrouter.ai/api/v1'
- Add defaultHeaders: HTTP-Referer (NEXT_PUBLIC_APP_URL), X-Title ('Meal Tracker SaaS')
- Export two analysis functions:
  - analyzeTextMeal(description): Uses 'openai/gpt-4o-mini' (cheap for text)
  - analyzeImageMeal(imageUrl): Uses 'openai/gpt-4o' (NOT mini - RESEARCH.md shows mini costs same for images due to high token usage)
- Both return structured JSON via response_format: { type: 'json_object' }

**lib/ai/prompts.ts:**
- Export NUTRITION_SYSTEM_PROMPT: Instruct model to return JSON with exact structure:
  ```json
  {
    "items": [{"name": "food", "quantity": "amount", "unit": "g/ml"}],
    "nutrition": {
      "calories": number,
      "protein_g": number,
      "carbs_g": number,
      "fat_g": number,
      "fiber_g": number,
      "sugar_g": number,
      "sodium_mg": number
    },
    "confidence": "high" | "medium" | "low",
    "notes": "uncertainty or estimation notes"
  }
  ```
- Include guidelines: round to reasonable precision, mark confidence based on portion clarity, prefer higher-calorie estimate when unsure

**lib/ai/types.ts:**
- Define NutritionResponse type matching JSON structure
- Export Zod schema for validation: nutritionResponseSchema

**Environment:**
- Add OPENROUTER_API_KEY to .env.local (placeholder: 'sk-or-v1-...')
- Add NEXT_PUBLIC_APP_URL to .env.local ('http://localhost:3000')
- Add both to .env.example with comments

CRITICAL: Use GPT-4o (not 4o-mini) for images - RESEARCH.md shows mini uses 20-33x more tokens for vision, making costs comparable. Only use mini for text-only analysis.
  </action>
  <verify>npm run build succeeds, openrouter client can be imported, prompts export valid strings, Zod schema validates sample nutrition data</verify>
  <done>OpenRouter client configured with correct models, prompts structured for JSON output, environment variables set, types defined for validation</done>
</task>

<task type="auto">
  <name>Task 3: Install AI dependencies</name>
  <files>package.json</files>
  <action>
Install required packages:
```bash
npm install openai compressorjs date-fns react-hook-form @hookform/resolvers
```

Versions:
- openai: ^4.x (OpenAI SDK compatible with OpenRouter)
- compressorjs: ^1.2.x (client-side image compression)
- date-fns: ^3.x (date formatting, meal time categorization)
- react-hook-form: ^7.x (form state management)
- @hookform/resolvers: ^3.x (Zod integration for forms)

Do NOT install @vercel/ai or @openrouter/ai-sdk-provider yet - those are optional for streaming (not needed for MVP).
  </action>
  <verify>npm install succeeds, npm list shows all packages installed, npm run dev starts without errors</verify>
  <done>All dependencies installed, package.json updated, no conflicts or errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Supabase Storage bucket 'meal-images' exists with RLS enabled
- [ ] Storage RLS policies prevent cross-user access (testable via Supabase Dashboard)
- [ ] OpenRouter client exports two functions: analyzeTextMeal, analyzeImageMeal
- [ ] Prompt templates return structured JSON format
- [ ] Environment variables set in .env.local (OPENROUTER_API_KEY, NEXT_PUBLIC_APP_URL)
- [ ] npm run build succeeds without errors
- [ ] All new dependencies installed and functional
</verification>

<success_criteria>

- All 3 tasks completed
- Storage infrastructure ready for image uploads
- AI client ready for nutrition analysis
- No TypeScript errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-meal-logging/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Storage & AI Infrastructure Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Created Supabase Storage bucket with RLS policies for user-scoped image uploads
- Built OpenRouter AI client with model selection (GPT-4o for images, GPT-4o-mini for text)
- Defined structured JSON prompts and response validation with Zod
- Installed all required dependencies for meal logging features

## Files Created/Modified

- `supabase/storage_setup.sql` - Storage bucket and RLS policies
- `lib/ai/openrouter.ts` - AI client with text and image analysis functions
- `lib/ai/prompts.ts` - Structured nutrition analysis prompts
- `lib/ai/types.ts` - NutritionResponse types and Zod schema
- `package.json` - Added openai, compressorjs, date-fns, react-hook-form, @hookform/resolvers
- `.env.local` - Added OPENROUTER_API_KEY, NEXT_PUBLIC_APP_URL
- `.env.example` - Template for new env vars with comments

## Decisions Made

- Use GPT-4o (not mini) for image analysis due to token usage parity
- Use GPT-4o-mini for text-only analysis (33x cheaper)
- Structured JSON output with response_format to ensure reliable parsing
- Path-based RLS policies using folder pattern for user isolation
- Skip streaming AI SDK for MVP (Vercel AI SDK optional)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 2: Manual Meal Entry Form - build form UI with validation and Server Actions
</output>
