---
phase: 02-meal-logging
plan: 02
type: execute
---

<objective>
Build manual meal entry form with validation, Server Actions for creating meals, and basic meal display page.

Purpose: Enable users to log meals manually with name, description, meal type, and timestamp before adding image/AI features.
Output: Working meal entry form that validates input, saves to database, and displays on meals list page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-meal-logging/02-RESEARCH.md
@.planning/phases/02-meal-logging/02-01-SUMMARY.md
@.planning/phases/01-foundation-database/01-03-SUMMARY.md
@app/actions/auth.ts
@lib/zod/schemas.ts
@components/auth/LoginForm.tsx
@supabase/migrations/20260111_initial_schema.sql

**Tech stack available:**
- react-hook-form + @hookform/resolvers for form handling
- Zod for validation
- Server Actions with useActionState pattern
- date-fns for date formatting

**Established patterns:**
- Server Actions pattern: 'use server', Zod validation, prevState for errors
- useActionState hook for loading states and progressive enhancement
- Protected layout pattern at route group level

**Constraining decisions:**
- Phase 01: Server Actions with useActionState hook for auth forms (apply same pattern here)
- Phase 01: Always use auth.getUser() never getSession()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meal validation schemas and types</name>
  <files>lib/zod/schemas.ts, types/meal.ts</files>
  <action>
Add to lib/zod/schemas.ts (append to existing file):

**MealFormSchema:**
```typescript
export const MealFormSchema = z.object({
  title: z.string().min(1, 'Meal name required').max(100, 'Name too long'),
  description: z.string().optional(),
  meal_type: z.enum(['breakfast', 'lunch', 'dinner', 'snack'], {
    required_error: 'Meal type required'
  }),
  logged_at: z.string().datetime(), // ISO string from client
  // Image fields added in Plan 3
});

export type MealFormData = z.infer<typeof MealFormSchema>;
```

Create types/meal.ts:
```typescript
export type MealType = 'breakfast' | 'lunch' | 'dinner' | 'snack';

export type Meal = {
  id: string;
  user_id: string;
  title: string;
  description: string | null;
  meal_type: MealType;
  logged_at: string;
  calories: number | null;
  protein: number | null;
  carbs: number | null;
  fat: number | null;
  fiber: number | null;
  sugar: number | null;
  sodium: number | null;
  photo_url: string | null;
  source: 'manual' | 'telegram_text' | 'telegram_image' | 'web';
  ai_confidence: number | null;
  created_at: string;
  updated_at: string;
};
```

Keep schemas simple for MVP - just basic meal info. AI analysis fields added in Plan 4.
  </action>
  <verify>npm run build succeeds, schemas export correctly, type MealFormData infers from Zod schema</verify>
  <done>Validation schema added to lib/zod/schemas.ts, Meal type defined in types/meal.ts, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Create Server Actions for meal CRUD operations</name>
  <files>app/(dashboard)/meals/actions.ts</files>
  <action>
Create app/(dashboard)/meals/actions.ts with Server Actions:

**Structure (following Phase 01 auth.ts pattern):**
```typescript
'use server';

import { z } from 'zod';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { MealFormSchema } from '@/lib/zod/schemas';

type State = {
  errors?: {
    title?: string[];
    meal_type?: string[];
    _form?: string[];
  };
  success?: boolean;
};

export async function createMeal(
  prevState: State,
  formData: FormData
): Promise<State> {
  // Validate with Zod
  const validated = MealFormSchema.safeParse({
    title: formData.get('title'),
    description: formData.get('description'),
    meal_type: formData.get('meal_type'),
    logged_at: formData.get('logged_at'),
  });

  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors,
    };
  }

  // Check auth
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { errors: { _form: ['Not authenticated'] } };
  }

  // Insert meal
  const { error } = await supabase.from('meal_logs').insert({
    user_id: user.id,
    title: validated.data.title,
    description: validated.data.description || null,
    meal_type: validated.data.meal_type,
    logged_at: new Date(validated.data.logged_at),
    source: 'manual',
  });

  if (error) {
    return { errors: { _form: [error.message] } };
  }

  revalidatePath('/dashboard/meals');
  return { success: true };
}
```

Keep it simple - just insert basic meal data. AI analysis integration comes in Plan 4. Follow exact pattern from auth.ts (useActionState-compatible).
  </action>
  <verify>npm run build succeeds, Server Action exports correctly, TypeScript validates State and formData types</verify>
  <done>createMeal Server Action created, follows useActionState pattern, validates with Zod, inserts to meal_logs table with RLS</done>
</task>

<task type="auto">
  <name>Task 3: Create meal entry form component and page</name>
  <files>components/meals/MealForm.tsx, app/(dashboard)/meals/new/page.tsx, app/(dashboard)/meals/page.tsx</files>
  <action>
Create components/meals/MealForm.tsx (follow LoginForm.tsx pattern):

**Key elements:**
- Use useActionState hook with createMeal action
- Use react-hook-form with zodResolver(MealFormSchema)
- Meal type select: dropdown with breakfast/lunch/dinner/snack
- logged_at: datetime-local input defaulting to now
- Submit button shows pending state
- Display field errors from state.errors
- On success: redirect or reset form

Create app/(dashboard)/meals/new/page.tsx:
- Simple layout with "Log New Meal" heading
- Render MealForm component
- Protected by (dashboard) layout (already has auth check from Phase 01)

Create app/(dashboard)/meals/page.tsx (basic list):
- Fetch meals from Supabase: `await supabase.from('meal_logs').select('*').order('logged_at', { ascending: false })`
- Display as simple list with: title, meal_type, logged_at (formatted with date-fns)
- Link to "Log New Meal" button
- Empty state if no meals

IMPORTANT: Follow Phase 01 form patterns exactly - useActionState + react-hook-form + zodResolver + Server Actions. No direct mutations, always Server Actions.
  </action>
  <verify>Visit /dashboard/meals/new, form renders, validation works, submit creates meal, /dashboard/meals shows meal in list</verify>
  <done>Form component with validation, new meal page functional, meals list page displays logged meals, follows established patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MealFormSchema validates correctly (test invalid inputs)
- [ ] createMeal Server Action inserts to database with RLS
- [ ] Form component shows validation errors
- [ ] Form submit creates meal and redirects/resets
- [ ] Meals list page displays created meals
- [ ] npm run build succeeds
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All 3 tasks completed
- Users can manually log meals with basic info
- Validation prevents invalid data
- Meals display on list page
- No errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-meal-logging/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Manual Meal Entry Form Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Created Zod validation schema for meal entry form
- Built Server Action for creating meals following Phase 01 patterns
- Implemented meal entry form with react-hook-form and useActionState
- Created meals list page displaying logged meals

## Files Created/Modified

- `lib/zod/schemas.ts` - Added MealFormSchema for validation
- `types/meal.ts` - Meal type definitions
- `app/(dashboard)/meals/actions.ts` - createMeal Server Action
- `components/meals/MealForm.tsx` - Form component with validation
- `app/(dashboard)/meals/new/page.tsx` - Meal entry page
- `app/(dashboard)/meals/page.tsx` - Meals list page

## Decisions Made

- Follow Phase 01 Server Actions + useActionState pattern for consistency
- datetime-local input for logged_at (native HTML5 input)
- Simple list view for meals (detailed view comes later)
- RLS policies from Phase 01 ensure user isolation

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 3: Image Upload & Compression - add image upload capability with client-side compression
</output>
