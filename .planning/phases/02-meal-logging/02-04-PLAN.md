---
phase: 02-meal-logging
plan: 04
type: execute
---

<objective>
Integrate OpenRouter AI analysis into meal entry workflow to automatically extract nutrition data from text descriptions and meal images.

Purpose: Enable automatic nutrition calculation, reducing manual data entry and providing accurate calorie/macro tracking.
Output: AI-powered nutrition analysis for both text and image-based meal entries with confidence scoring.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-meal-logging/02-RESEARCH.md
@.planning/phases/02-meal-logging/02-01-SUMMARY.md
@.planning/phases/02-meal-logging/02-03-SUMMARY.md
@app/(dashboard)/meals/actions.ts
@components/meals/MealForm.tsx
@lib/ai/openrouter.ts
@lib/ai/prompts.ts
@lib/ai/types.ts
@supabase/migrations/20260111_initial_schema.sql

**Tech stack available:**
- OpenRouter client with GPT-4o and GPT-4o-mini (from Plan 1)
- Structured JSON prompts and Zod validation (from Plan 1)
- Supabase Storage for image URLs (from Plan 3)

**Established patterns:**
- Server Actions for backend operations
- Zod validation for all data
- auth.getUser() for authentication

**Research findings:**
- Use GPT-4o for images, GPT-4o-mini for text (RESEARCH.md token cost analysis)
- Request structured JSON output with response_format
- Include confidence scoring (high/medium/low)
- AI achieves 87.5% food identification accuracy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI analysis API routes</name>
  <files>app/api/ai/analyze/route.ts, lib/ai/parsers.ts</files>
  <action>
Create app/api/ai/analyze/route.ts (POST endpoint):

**Route handler:**
```typescript
import { NextRequest } from 'next/server';
import { analyzeTextMeal, analyzeImageMeal } from '@/lib/ai/openrouter';
import { nutritionResponseSchema } from '@/lib/ai/types';
import { createClient } from '@/lib/supabase/server';

export async function POST(req: NextRequest) {
  // Auth check
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await req.json();
  const { text, imageUrl } = body;

  try {
    let result;
    if (imageUrl) {
      result = await analyzeImageMeal(imageUrl); // GPT-4o
    } else if (text) {
      result = await analyzeTextMeal(text); // GPT-4o-mini
    } else {
      return Response.json({ error: 'Text or imageUrl required' }, { status: 400 });
    }

    return Response.json(result);
  } catch (error) {
    console.error('AI analysis error:', error);
    return Response.json({ error: 'Analysis failed' }, { status: 500 });
  }
}
```

Create lib/ai/parsers.ts:
```typescript
import { nutritionResponseSchema } from './types';

export function parseNutritionResponse(content: string) {
  const parsed = JSON.parse(content);
  return nutritionResponseSchema.parse(parsed); // Validate with Zod
}
```

Update lib/ai/openrouter.ts to use parsers:
- Both analyzeTextMeal and analyzeImageMeal should call parseNutritionResponse
- Return validated NutritionResponse type

CRITICAL: Separate API route (not Server Action) because AI analysis can take 3-10 seconds. API route allows client-side loading states and doesn't block form submission.
  </action>
  <verify>POST to /api/ai/analyze with text returns nutrition JSON, POST with imageUrl returns nutrition JSON, unauthorized returns 401</verify>
  <done>AI analysis API route created, handles both text and image inputs, validates responses with Zod, returns structured nutrition data</done>
</task>

<task type="auto">
  <name>Task 2: Add "Analyze with AI" button to meal form</name>
  <files>components/meals/MealForm.tsx, components/meals/NutritionDisplay.tsx</files>
  <action>
Update components/meals/MealForm.tsx:

**Add AI analysis flow:**
1. Add "Analyze with AI" button (disabled if no description and no photo_url)
2. On click:
   - Call /api/ai/analyze with { text: description } or { imageUrl: photo_url }
   - Show loading state ("Analyzing...")
   - On success: populate hidden fields with nutrition data
   - On error: show error message
3. Store AI response in form state for nutrition fields

**Add hidden fields to form:**
- calories, protein, carbs, fat, fiber, sugar, sodium (as hidden inputs or form.setValue)
- ai_confidence (from AI response)

Create components/meals/NutritionDisplay.tsx:
- Display nutrition results after AI analysis
- Show: Calories, Protein, Carbs, Fat (primary macros)
- Show confidence badge (high=green, medium=yellow, low=red)
- Show "notes" from AI if confidence is low
- Allow manual override (editable inputs)

**Flow:**
1. User enters meal description OR uploads image
2. Clicks "Analyze with AI"
3. Loading spinner while AI processes
4. NutritionDisplay shows results
5. User can edit values if needed
6. Submit form saves all data

Keep UI simple - focus on functional AI integration. Polish comes later.
  </action>
  <verify>Click "Analyze with AI" with text description, nutrition data populates, click with image URL, nutrition data populates, confidence displays correctly</verify>
  <done>"Analyze with AI" button triggers analysis, nutrition data displays in form, confidence scoring visible, manual override enabled</done>
</task>

<task type="auto">
  <name>Task 3: Update meal creation to save nutrition data</name>
  <files>app/(dashboard)/meals/actions.ts, lib/zod/schemas.ts, app/(dashboard)/meals/page.tsx</files>
  <action>
Update lib/zod/schemas.ts MealFormSchema:
- Add optional nutrition fields: calories, protein, carbs, fat, fiber, sugar, sodium (all z.number().optional())
- Add ai_confidence: z.number().min(0).max(1).optional()

Update app/(dashboard)/meals/actions.ts createMeal:
- Accept nutrition fields from formData
- Save to meal_logs table (columns already exist from Phase 01 schema)
- Convert string inputs to numbers
- Validate with updated MealFormSchema

Update app/(dashboard)/meals/page.tsx (meals list):
- Display nutrition summary if available: "450 cal | 25g protein | 40g carbs | 15g fat"
- Show AI confidence badge if ai_confidence exists
- Show "Manual entry" badge if no AI data
- Keep design minimal - detailed nutrition view comes in Phase 4/5

**Database fields (from Phase 01 schema):**
- calories: INTEGER
- protein, carbs, fat, fiber, sugar, sodium: DECIMAL(5,2)
- ai_confidence: DECIMAL(3,2) (0.00 to 1.00)

All fields nullable - manual entry without AI is valid.
  </action>
  <verify>Submit form with AI-analyzed data, verify meal_logs contains nutrition values, meals list displays nutrition summary, confidence badge shows</verify>
  <done>Meal creation saves nutrition data, database stores AI analysis results, meals list displays nutrition summary with confidence indicator</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /api/ai/analyze returns valid nutrition data for text input
- [ ] /api/ai/analyze returns valid nutrition data for image input
- [ ] "Analyze with AI" button works in meal form
- [ ] NutritionDisplay component shows results with confidence
- [ ] Manual override of nutrition values works
- [ ] Meal creation saves all nutrition fields to database
- [ ] Meals list displays nutrition summary
- [ ] npm run build succeeds
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All 3 tasks completed
- AI analysis integrated into meal entry workflow
- Both text and image analysis functional
- Nutrition data saved to database
- Confidence scoring visible to users
- No errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-meal-logging/02-04-SUMMARY.md`:

# Phase 2 Plan 4: AI Nutrition Analysis Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Created AI analysis API route supporting text and image inputs
- Integrated "Analyze with AI" button into meal entry form
- Built NutritionDisplay component showing results with confidence scoring
- Meal creation now saves complete nutrition data from AI analysis
- Meals list displays nutrition summaries

## Files Created/Modified

- `app/api/ai/analyze/route.ts` - AI analysis endpoint (text & image)
- `lib/ai/parsers.ts` - Parse and validate AI responses
- `lib/ai/openrouter.ts` - Updated to use parsers
- `components/meals/MealForm.tsx` - Added AI analysis trigger
- `components/meals/NutritionDisplay.tsx` - Display nutrition results
- `app/(dashboard)/meals/actions.ts` - Save nutrition data
- `lib/zod/schemas.ts` - Added nutrition fields to schema
- `app/(dashboard)/meals/page.tsx` - Display nutrition summaries

## Decisions Made

- API route (not Server Action) for AI analysis to enable loading states
- Manual override allowed after AI analysis for user corrections
- Confidence scoring displayed to set user expectations
- GPT-4o for images, GPT-4o-mini for text (cost optimization)
- All nutrition fields optional (manual entry without AI valid)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 5: Edit & Delete Meals - add functionality to modify and remove meal entries
</output>
