---
phase: 02-meal-logging
plan: 03
type: execute
---

<objective>
Add image upload capability to meal entry form with client-side compression and Supabase Storage integration using signed URLs.

Purpose: Enable users to attach photos to meal entries, bypassing Next.js 1MB Server Action limit via direct-to-storage uploads.
Output: Image upload component with preview, compression, and signed URL upload pattern.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-meal-logging/02-RESEARCH.md
@.planning/phases/02-meal-logging/02-01-SUMMARY.md
@.planning/phases/02-meal-logging/02-02-SUMMARY.md
@app/(dashboard)/meals/actions.ts
@components/meals/MealForm.tsx
@lib/supabase/client.ts
@lib/supabase/server.ts

**Tech stack available:**
- compressorjs for client-side image compression
- Supabase Storage with signed URLs (from Plan 1)
- react-hook-form for form state

**Established patterns:**
- Server Actions for backend operations
- Supabase Storage RLS policies (user_id folder pattern)

**Research findings:**
- RESEARCH.md: Use signed URLs to bypass 1MB Server Action limit
- Compress images to 800-1200px width before upload
- Target ~200-400KB per image after compression
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action for signed upload URLs</name>
  <files>app/(dashboard)/meals/actions.ts, lib/storage/images.ts</files>
  <action>
Add to app/(dashboard)/meals/actions.ts:

**getUploadUrl Server Action:**
```typescript
export async function getUploadUrl(fileName: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    throw new Error('Not authenticated');
  }

  // User-scoped path: {user_id}/{timestamp}-{filename}
  const filePath = `${user.id}/${Date.now()}-${fileName}`;

  // Create signed URL (expires in 2 hours)
  const { data, error } = await supabase.storage
    .from('meal-images')
    .createSignedUploadUrl(filePath);

  if (error) throw error;

  return {
    signedUrl: data.signedUrl,
    path: filePath,
    token: data.token,
  };
}
```

Create lib/storage/images.ts with utility:
```typescript
import { createClient } from '@/lib/supabase/client';

export function getPublicUrl(path: string): string {
  const supabase = createClient();
  const { data } = supabase.storage
    .from('meal-images')
    .getPublicUrl(path);
  return data.publicUrl;
}
```

This follows RESEARCH.md Pattern 2: Supabase Storage Signed URLs. The signed URL allows client-side direct upload, bypassing server payload limits.
  </action>
  <verify>Call getUploadUrl('test.jpg'), verify returns signedUrl and path, no errors</verify>
  <done>getUploadUrl Server Action created, returns signed URL for client uploads, path follows user_id/{timestamp}-{filename} pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create image upload component with compression</name>
  <files>components/meals/ImageUpload.tsx</files>
  <action>
Create components/meals/ImageUpload.tsx:

**Key functionality:**
1. File input (accept="image/jpeg,image/png,image/webp")
2. Client-side compression with compressorjs:
   - Target: maxWidth 1200px, quality 0.8
   - Converts to WebP for smaller size
3. Upload flow:
   - User selects image → compress → getUploadUrl → PUT to signedUrl → getPublicUrl → return URL
4. Show preview thumbnail after upload
5. Expose selected image URL to parent form via callback prop

**Component props:**
```typescript
type ImageUploadProps = {
  value?: string; // Current image URL
  onChange: (url: string | null) => void;
  disabled?: boolean;
};
```

**Key implementation points:**
- Use compressorjs for compression (installed in Plan 1)
- Call getUploadUrl Server Action to get signed URL
- Direct PUT request to signed URL with compressed blob
- Get public URL after upload via getPublicUrl helper
- Show loading state during upload
- Handle errors gracefully with user-friendly messages

CRITICAL: Compress BEFORE upload to keep costs low. RESEARCH.md shows phone photos are 5-10MB, compress to ~200-400KB.
  </action>
  <verify>Component renders file input, compression works (check output size), upload succeeds, preview shows, public URL returned</verify>
  <done>ImageUpload component with compression, signed URL upload, preview, integrates with react-hook-form via onChange</done>
</task>

<task type="auto">
  <name>Task 3: Integrate image upload into meal form</name>
  <files>components/meals/MealForm.tsx, lib/zod/schemas.ts, app/(dashboard)/meals/actions.ts</files>
  <action>
Update components/meals/MealForm.tsx:
- Add ImageUpload component to form
- Use react-hook-form field for photo_url: `<ImageUpload value={form.watch('photo_url')} onChange={(url) => form.setValue('photo_url', url)} />`
- Include hidden input for photo_url to pass to Server Action
- Optional: Add "Remove image" button if photo_url set

Update lib/zod/schemas.ts MealFormSchema:
- Add field: `photo_url: z.string().url().nullable().optional()`

Update app/(dashboard)/meals/actions.ts createMeal:
- Accept photo_url from formData
- Save to meal_logs.photo_url field
- Validate URL format with Zod

Update app/(dashboard)/meals/page.tsx (meals list):
- If meal.photo_url exists, show thumbnail (Next.js Image component)
- Handle missing images gracefully

Result: Users can optionally upload meal photos during entry, photos stored in user-scoped Storage folder, URLs saved to database.
  </action>
  <verify>Upload image in form, verify stored in Supabase Storage under user_id folder, meal_logs.photo_url contains public URL, thumbnail displays on meals list</verify>
  <done>Image upload integrated into meal form, photos stored in Supabase Storage, URLs saved to database, thumbnails display in meals list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getUploadUrl Server Action returns valid signed URL
- [ ] Image compression reduces file size to ~200-400KB
- [ ] Upload bypasses server (direct to Supabase Storage)
- [ ] Uploaded images accessible via public URL
- [ ] RLS policies enforce user_id folder isolation
- [ ] Meal form saves photo_url to database
- [ ] Meals list displays image thumbnails
- [ ] npm run build succeeds
</verification>

<success_criteria>

- All 3 tasks completed
- Users can upload meal photos
- Images compressed client-side before upload
- Photos stored in Supabase Storage with RLS
- No server payload limit issues
- No errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-meal-logging/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Image Upload & Compression Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Created Server Action for Supabase Storage signed upload URLs
- Built ImageUpload component with client-side compression (compressorjs)
- Integrated image upload into meal entry form
- Images stored in user-scoped folders with RLS enforcement

## Files Created/Modified

- `app/(dashboard)/meals/actions.ts` - Added getUploadUrl Server Action
- `lib/storage/images.ts` - Helper for public URL generation
- `components/meals/ImageUpload.tsx` - Upload component with compression
- `components/meals/MealForm.tsx` - Integrated ImageUpload
- `lib/zod/schemas.ts` - Added photo_url field to MealFormSchema
- `app/(dashboard)/meals/page.tsx` - Display thumbnails in meals list

## Decisions Made

- Target 1200px max width for compression (balance quality/size)
- Use WebP format for smaller file sizes
- Signed URL pattern bypasses 1MB Server Action limit
- User-scoped folder structure (user_id/{timestamp}-{filename})
- Optional image upload (not required for meal entry)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 4: AI Nutrition Analysis - integrate OpenRouter to analyze text and images for nutrition data
</output>
