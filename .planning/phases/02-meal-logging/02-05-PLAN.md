---
phase: 02-meal-logging
plan: 05
type: execute
---

<objective>
Add edit and delete functionality for meal entries, completing the full CRUD operations for the meal logging system.

Purpose: Enable users to correct mistakes, update meal details, or remove entries entirely.
Output: Edit page for existing meals, delete confirmation, and updated meal actions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-meal-logging/02-RESEARCH.md
@.planning/phases/02-meal-logging/02-02-SUMMARY.md
@.planning/phases/02-meal-logging/02-04-SUMMARY.md
@app/(dashboard)/meals/actions.ts
@components/meals/MealForm.tsx
@app/(dashboard)/meals/page.tsx
@supabase/migrations/20260111_initial_schema.sql

**Tech stack available:**
- Server Actions with RLS enforcement
- Zod validation
- react-hook-form for edit forms

**Established patterns:**
- Server Actions for mutations (Phase 01)
- RLS policies enforce user_id isolation (Phase 01)
- useActionState for form submissions (Phase 01)

**Constraining decisions:**
- Phase 01: Always use auth.getUser() never getSession()
- RLS policies automatically enforce user can only edit/delete own meals
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Actions for update and delete operations</name>
  <files>app/(dashboard)/meals/actions.ts</files>
  <action>
Add to app/(dashboard)/meals/actions.ts:

**updateMeal Server Action:**
```typescript
type UpdateMealState = {
  errors?: {
    title?: string[];
    _form?: string[];
  };
  success?: boolean;
};

export async function updateMeal(
  mealId: string,
  prevState: UpdateMealState,
  formData: FormData
): Promise<UpdateMealState> {
  // Validate with MealFormSchema (reuse from create)
  const validated = MealFormSchema.safeParse({
    title: formData.get('title'),
    description: formData.get('description'),
    meal_type: formData.get('meal_type'),
    logged_at: formData.get('logged_at'),
    photo_url: formData.get('photo_url'),
    calories: formData.get('calories') ? Number(formData.get('calories')) : undefined,
    protein: formData.get('protein') ? Number(formData.get('protein')) : undefined,
    // ... other nutrition fields
  });

  if (!validated.success) {
    return { errors: validated.error.flatten().fieldErrors };
  }

  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { errors: { _form: ['Not authenticated'] } };
  }

  // Update - RLS ensures user can only update their own meals
  const { error } = await supabase
    .from('meal_logs')
    .update({
      ...validated.data,
      logged_at: new Date(validated.data.logged_at),
      updated_at: new Date(),
    })
    .eq('id', mealId);

  if (error) {
    return { errors: { _form: [error.message] } };
  }

  revalidatePath('/dashboard/meals');
  return { success: true };
}

**deleteMeal Server Action:**
```typescript
export async function deleteMeal(mealId: string): Promise<{ success: boolean; error?: string }> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: 'Not authenticated' };
  }

  // Delete meal image from storage if exists
  const { data: meal } = await supabase
    .from('meal_logs')
    .select('photo_url')
    .eq('id', mealId)
    .single();

  if (meal?.photo_url) {
    // Extract path from URL and delete from storage
    const urlPath = new URL(meal.photo_url).pathname;
    const storagePath = urlPath.split('/meal-images/')[1];
    if (storagePath) {
      await supabase.storage.from('meal-images').remove([storagePath]);
    }
  }

  // Delete meal - RLS ensures user can only delete their own meals
  const { error } = await supabase
    .from('meal_logs')
    .delete()
    .eq('id', mealId);

  if (error) {
    return { success: false, error: error.message };
  }

  revalidatePath('/dashboard/meals');
  return { success: true };
}
```

IMPORTANT: RLS policies from Phase 01 automatically prevent users from updating/deleting other users' meals. No additional auth checks needed beyond auth.getUser().
  </action>
  <verify>Call updateMeal for own meal succeeds, attempt to update another user's meal returns no rows affected (RLS blocks), deleteMeal removes meal and image</verify>
  <done>updateMeal and deleteMeal Server Actions created, RLS enforces ownership, image cleanup on delete</done>
</task>

<task type="auto">
  <name>Task 2: Create edit page and update meal form</name>
  <files>app/(dashboard)/meals/[id]/edit/page.tsx, components/meals/MealForm.tsx</files>
  <action>
Create app/(dashboard)/meals/[id]/edit/page.tsx:

**Fetch existing meal:**
```typescript
const supabase = await createClient();
const { data: meal } = await supabase
  .from('meal_logs')
  .select('*')
  .eq('id', params.id)
  .single();

if (!meal) {
  notFound();
}
```

**Render form with initial values:**
- Pass meal data to MealForm as initialData prop
- Use updateMeal action (with mealId bound via .bind())
- Show "Update Meal" heading instead of "Create Meal"

Update components/meals/MealForm.tsx:
- Accept optional initialData prop for edit mode
- Set form defaultValues from initialData
- Accept action prop to support both createMeal and updateMeal
- Keep same validation and AI analysis features

**Route structure:**
- Create: /dashboard/meals/new (existing)
- Edit: /dashboard/meals/[id]/edit (new)
- List: /dashboard/meals (existing)

Reuse existing MealForm component by making it flexible (create vs edit mode).
  </action>
  <verify>Navigate to /dashboard/meals/[id]/edit, form pre-populated with meal data, update saves changes, RLS prevents editing other users' meals</verify>
  <done>Edit page created, MealForm supports both create and edit modes, initial data pre-populated, update saves successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete meal logging CRUD system with AI analysis</what-built>
  <how-to-verify>
Test the full meal logging workflow:

1. **Create meal with text:**
   - Visit /dashboard/meals/new
   - Enter meal name: "Chicken breast with rice and broccoli"
   - Select meal type: lunch
   - Click "Analyze with AI"
   - Verify nutrition data populates (calories, protein, carbs, fat)
   - Verify confidence badge displays
   - Submit form
   - Verify meal appears in /dashboard/meals list with nutrition summary

2. **Create meal with image:**
   - Visit /dashboard/meals/new
   - Upload a meal photo (use test image or real photo)
   - Verify image compresses and preview shows
   - Click "Analyze with AI"
   - Verify AI analyzes image and returns nutrition data
   - Submit form
   - Verify meal shows with thumbnail in list

3. **Edit meal:**
   - Click "Edit" on a meal in the list
   - Modify meal name and description
   - Update nutrition values manually
   - Save changes
   - Verify updates reflected in list

4. **Delete meal:**
   - Click "Delete" on a meal
   - Confirm deletion
   - Verify meal removed from list
   - Check Supabase Storage: meal image deleted

5. **RLS verification:**
   - Verify you can only see your own meals in list
   - Verify attempting to access another user's meal edit URL returns 404

Expected results:
- All operations work smoothly
- AI analysis provides reasonable nutrition estimates
- Images compress and upload without errors
- Edit/delete operations restricted by RLS
- No console errors or warnings
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add edit/delete buttons to meals list</name>
  <files>app/(dashboard)/meals/page.tsx, components/meals/DeleteButton.tsx</files>
  <action>
Update app/(dashboard)/meals/page.tsx:

**Add action buttons to each meal card:**
- Edit button: Link to /dashboard/meals/[id]/edit
- Delete button: Client component with confirmation

Create components/meals/DeleteButton.tsx:
```typescript
'use client';

import { useState } from 'react';
import { deleteMeal } from '@/app/(dashboard)/meals/actions';

export function DeleteButton({ mealId }: { mealId: string }) {
  const [isDeleting, setIsDeleting] = useState(false);

  async function handleDelete() {
    if (!confirm('Delete this meal? This cannot be undone.')) {
      return;
    }

    setIsDeleting(true);
    const result = await deleteMeal(mealId);

    if (!result.success) {
      alert(result.error || 'Failed to delete meal');
      setIsDeleting(false);
    }
    // On success, revalidatePath in deleteMeal refreshes the page
  }

  return (
    <button
      onClick={handleDelete}
      disabled={isDeleting}
      className="text-red-600 hover:text-red-800"
    >
      {isDeleting ? 'Deleting...' : 'Delete'}
    </button>
  );
}
```

**Design:**
- Simple buttons with edit/delete actions
- Delete shows native confirm() dialog (polish later)
- Loading states for async operations

Keep UI minimal - detailed meal view and better UX come in Phase 4.
  </action>
  <verify>Edit button navigates to edit page, delete button shows confirmation, deleting removes meal and refreshes list</verify>
  <done>Edit and delete buttons added to meals list, deletion requires confirmation, actions trigger successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] updateMeal Server Action updates database with RLS enforcement
- [ ] deleteMeal Server Action removes meal and associated image
- [ ] Edit page pre-populates form with existing meal data
- [ ] Edit form submits updates successfully
- [ ] Delete button shows confirmation before deletion
- [ ] Meals list shows edit/delete buttons
- [ ] Manual testing checkpoint completed and approved
- [ ] npm run build succeeds
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All 4 tasks completed (3 auto + 1 checkpoint)
- Full CRUD operations functional
- RLS enforces user isolation
- Edit/delete buttons integrated into UI
- Manual testing verified
- Phase 2 COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/02-meal-logging/02-05-SUMMARY.md`:

# Phase 2 Plan 5: Edit & Delete Meals Summary

**Complete meal logging system with create, read, update, delete operations and AI-powered nutrition analysis**

## Accomplishments

- Created updateMeal and deleteMeal Server Actions with RLS enforcement
- Built edit page reusing MealForm component in edit mode
- Added edit/delete buttons to meals list with confirmation
- Implemented image cleanup on meal deletion
- Verified full CRUD workflow via manual testing

## Files Created/Modified

- `app/(dashboard)/meals/actions.ts` - Added updateMeal, deleteMeal actions
- `app/(dashboard)/meals/[id]/edit/page.tsx` - Edit page with pre-populated form
- `components/meals/MealForm.tsx` - Enhanced to support create/edit modes
- `components/meals/DeleteButton.tsx` - Delete confirmation component
- `app/(dashboard)/meals/page.tsx` - Added edit/delete action buttons

## Decisions Made

- Reused MealForm for both create and edit (DRY principle)
- Native confirm() dialog for delete confirmation (polish later)
- Image cleanup on deletion to prevent orphaned files
- RLS policies automatically enforce ownership (no additional checks)

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase Complete!

**Phase 2: Meal Logging System â€” COMPLETE** ðŸŽ‰

Users can now:
- âœ… Manually log meals with name, description, meal type, timestamp
- âœ… Upload meal photos with client-side compression
- âœ… Analyze meals with AI (text or image) for automatic nutrition calculation
- âœ… View nutrition data with confidence scoring
- âœ… Edit existing meal entries
- âœ… Delete meal entries with image cleanup
- âœ… All operations protected by RLS (user data isolation)

## Next Phase

Phase 3: Telegram Integration - Connect n8n Telegram bot for real-time meal sync from Telegram messages and images.
</output>
